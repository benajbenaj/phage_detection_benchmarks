# Data Analysis Scripts

All R scripts should should be run from the root of this project, since that is where the `.Rproj` file and `renv/` are located.

# Classified Chopped Genomes

## Scripts

### `extract_ids.R`

Input: file generated by running `grep -r ">" data/refseq/*/*.fna > data/refseq_info/ids.txt`

Output: `{outdir}/extracted_ids.csv`

Description: Parses the grep output to extract the assembly accession id from the file names and sequence ids inside those files.

Help message:
```
$ src/data_analysis/extract_ids.R -h

usage: src/data_analysis/extract_ids.R [-h] [-o OUTDIR] FILE

Extract Assembly Accession and Record IDs

positional arguments:
  FILE                          File resulting from grep '>' on genome files

optional arguments:
  -h, --help                    show this help message and exit
  -o OUTDIR, --outdir OUTDIR    Output directory
```

Usage example
```
$ head -n 5 data/refseq_info/ids.txt
archaea/GCF_000006175.1_ASM617v2_genomic.fna:>NC_014222.1 Methanococcus voltae A3, complete sequence
archaea/GCF_000006805.1_ASM680v1_genomic.fna:>NC_002607.1 Halobacterium salinarum NRC-1, complete sequence
archaea/GCF_000006805.1_ASM680v1_genomic.fna:>NC_001869.1 Halobacterium salinarum NRC-1 plasmid pNRC100, complete sequence
archaea/GCF_000006805.1_ASM680v1_genomic.fna:>NC_002608.1 Halobacterium salinarum NRC-1 plasmid pNRC200, complete sequence
archaea/GCF_000007005.1_ASM700v1_genomic.fna:>NC_002754.1 Saccharolobus solfataricus P2, complete sequence

$ src/data_analysis/extract_ids.R data/refseq_info/ids.txt -o data/refseq_info
Done. Wrote file to 'data/refseq_info/extracted_ids.csv'

$ head -n 5 data/refseq_info/extracted_ids.csv
"kingdom","accesssion","seq_id"
"archaea","GCF_000006175.1","NC_014222.1"
"archaea","GCF_000006805.1","NC_002607.1"
"archaea","GCF_000006805.1","NC_001869.1"
"archaea","GCF_000006805.1","NC_002608.1"
```

___

### `get_tax_ids.R`

Input:

* refseq assembly files
* `-i, --ids`: file of extracted ids from `extract_ids.R`

Output: file containing sequence IDs, assembly accession IDs, and taxIDS, `{out_dir}/tax_ids.csv`

Description: join the sequence IDs to the TaxIDs on the assembly accession IDs.

Help message:
```
$ src/data_analysis/get_tax_ids.R -h
usage: src/data_analysis/get_tax_ids.R [-h] -i FILE [-o DIR] FILE [FILE]

Retrieve and join taxIDs

positional arguments:
  FILE                          RefSeq assembly information files
optional arguments:
  -h, --help                    show this help message and exit
  -i FILE, --ids FILE           Extracted accession and seq IDs file
  -o OUTDIR, --outdir OUTDIR    Output directory
```

Usage example:
```
$ src/data_analysis/get_tax_ids.R \
    -i data/refseq_info/extracted_ids.csv \
    -o data/refseq_info \
    data/refseq_info/{archaea,bacteria,fungi,viral}.txt
Done. Wrote file to 'data/refseq_info/tax_ids.csv'

$ head -n 5 data/refseq_info/tax_ids.csv
"kingdom","accession","seq_id","taxid","species_taxid"
"archaea","GCF_000006175.1","NC_014222.1",456320,2188
"archaea","GCF_000006805.1","NC_002607.1",64091,2242
"archaea","GCF_000006805.1","NC_001869.1",64091,2242
"archaea","GCF_000006805.1","NC_002608.1",64091,2242
```

___

### `get_taxonomy.R`

Input: 

* output file from `get_tax_ids.R`
* `-d, --db`: taxonomizr sqlite database location (default: **data/taxonomizr/accession_taxa.sql**)

Output: file with full taxonomy information, `{out_dir}/taxonomy.csv`

Description: Use the `taxonomizr` package to retrieve taxonomy from taxIDs

Help message:
```
$ src/data_analysis/get_taxonomy.R -h
usage: src/data_analysis/get_taxonomy.R [-h] [-o DIR] [-d DB] FILE

Get taxonomy using taxonomizr

positional arguments:
  FILE                  File with taxid column

optional arguments:
  -h, --help            show this help message and exit
  -o DIR, --outdir DIR  Output directory
  -d DB, --db DB        taxonomizr database
```

Usage example:
```
$ src/data_analysis/get_taxonomy.R -o data/refseq_info data/refseq_info/tax_ids.csv
Done. Wrote file to 'data/refseq_info/taxonomy.csv'

$ head -n 5 data/refseq_info/taxonomy.csv
"kingdom","accession","seq_id","taxid","species_taxid","superkingdom","phylum","class","order","family","genus","species"
"archaea","GCF_000006175.1","NC_014222.1",456320,2188,"Archaea","Euryarchaeota","Methanococci","Methanococcales","Methanococcaceae","Methanococcus","Methanococcus voltae"
"archaea","GCF_000006805.1","NC_002607.1",64091,2242,"Archaea","Euryarchaeota","Halobacteria","Halobacteriales","Halobacteriaceae","Halobacterium","Halobacterium salinarum"
"archaea","GCF_000006805.1","NC_001869.1",64091,2242,"Archaea","Euryarchaeota","Halobacteria","Halobacteriales","Halobacteriaceae","Halobacterium","Halobacterium salinarum"
"archaea","GCF_000006805.1","NC_002608.1",64091,2242,"Archaea","Euryarchaeota","Halobacteria","Halobacteriales","Halobacteriaceae","Halobacterium","Halobacterium salinarum"
```

---

### `clean_classifications.R`

Description:

1. Fill in missing negative classifications for tools that only return positive predictions.
2. Standardize predicted classes to only "viral" and "non-viral"
3. Restylize the names of the classifiers (*e.g.* 'dvf' > 'DeepVirFinder')
4. Join taxonomy information columns

Input:

* File of combined classifications (*e.g.* data/classified_chopped/combined_out/combined.csv)
* `--taxonomy`: file with taxonomy information, generated by `get_taxonomy.R`
* `--key`: file with lists of classifications associated with viral and non-viral classifications

Output: classifications file (`{out_dir}/cleaned_combined.csv`)

Help message:
```
$ src/data_analysis/clean_classifications.R -h
usage: src/data_analysis/clean_classifications.R [-h] [-t FILE] [-k FILE]
                                                 [-o DIR]
                                                 FILE

Clean combined classifications

positional arguments:
  FILE                  Combined classifications

optional arguments:
  -h, --help                show this help message and exit
  -t FILE, --taxonomy FILE  Taxonomy information file
  -k FILE, --key FILE       Classification key
  -o DIR, --outdir DIR      Output directory
```

Example usage:
```
$ src/data_analysis/clean_classifications.R \
    data/classified_chopped_small/combined_out/combined.csv
Done. Wrote file to 'out/cleaned_combined.csv
```





